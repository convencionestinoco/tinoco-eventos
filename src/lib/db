import { supabase } from './supabase';
import { EventData, Advance } from './types';

export async function fetchEvents(): Promise<EventData[]> {
  const { data: events, error } = await supabase
    .from('events')
    .select('*')
    .order('date', { ascending: true });

  if (error) { console.error('Error fetching events:', error); return []; }

  const { data: advances, error: advError } = await supabase
    .from('advances')
    .select('*');

  if (advError) console.error('Error fetching advances:', advError);

  return (events || []).map(evt => ({
    ...evt,
    amount: Number(evt.amount) || 0,
    advances: (advances || [])
      .filter(a => a.event_id === evt.id)
      .map(a => ({ id: a.id, event_id: a.event_id, amount: Number(a.amount), locked: a.locked }))
  }));
}

export async function saveEvent(event: EventData): Promise<EventData | null> {
  const { advances, ...evtData } = event;
  const payload = {
    type: evtData.type,
    name: evtData.name,
    date: evtData.date,
    venue: evtData.venue,
    time: evtData.time,
    guests: evtData.guests,
    decoration_color: evtData.decoration_color,
    observations: evtData.observations,
    status: evtData.status,
    amount: evtData.amount || 0,
  };

  let eventId = evtData.id;

  if (eventId) {
    // Update
    const { error } = await supabase.from('events').update(payload).eq('id', eventId);
    if (error) { console.error('Error updating event:', error); throw error; }
  } else {
    // Insert
    const { data, error } = await supabase.from('events').insert(payload).select().single();
    if (error) { console.error('Error inserting event:', error); throw error; }
    eventId = data.id;
  }

  // Sync advances: delete removed, upsert existing/new
  const { data: existingAdv } = await supabase.from('advances').select('id').eq('event_id', eventId);
  const existingIds = (existingAdv || []).map(a => a.id);
  const currentIds = advances.filter(a => a.id).map(a => a.id!);
  const toDelete = existingIds.filter(id => !currentIds.includes(id));

  if (toDelete.length > 0) {
    await supabase.from('advances').delete().in('id', toDelete);
  }

  for (const adv of advances) {
    if (adv.id && existingIds.includes(adv.id)) {
      await supabase.from('advances').update({ amount: adv.amount, locked: adv.locked }).eq('id', adv.id);
    } else {
      await supabase.from('advances').insert({ event_id: eventId, amount: adv.amount, locked: adv.locked });
    }
  }

  return { ...event, id: eventId };
}

export async function deleteEvent(id: string): Promise<void> {
  const { error } = await supabase.from('events').delete().eq('id', id);
  if (error) { console.error('Error deleting event:', error); throw error; }
}
